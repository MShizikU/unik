<?php
$amo_crm_authorization_code = "def5020033d15509c0fec9d844505ad7ab2ad8bdb831880ed205db3bc050d13d04955ec260afb43db594a118c5d8277d35f6a11b89ccbe41c5dd70a5cf18543feea6500564ff0d1c46a67998780e248156e09035c35870b85519e82dee4a7b900ff6e1de608493e4d5242ef8f5a55f3b3902397e3b6ef3e76888afa28c4a438f6dd9debb9c670fe12d917f2d29a9aa56603182ca9944fac7c19da04d6a6e971c3786e968f0189eb037f0fc2e7c8b4ab949227a95238e830249d1bb59d2fb5030d7d79b8c0975a3b1ea831bac460d39ae17a006edcdb7235363b405dca763e6d0e0db9ec426e48ad58813b8aa719bd4bc1c3e4d0651ed39ce886672f7dc5ddba16cdeee50d75f69c5d1adfbd90536a12af895b587ee643de7a34df9d099dff9c6be78491bfacc8a5393aa6e1af84ef31abd4184a3667aa7c29b097e80e882c9292c938ca213249cbae38db80477637c6e72fbb85ded908c9773e756bb4b887a131b36d1ec07948263986904accae14c0aa2ef78367dc4b369f37d55432aafa82783524af31f63e69b28f0fa05e8b2f6145ac596fa2faed21448f3fc013af56fc467e6d338fe51c23d832b824be6f34e57dd0687bbcc3e7fd5018f1d007f30e5228eeccd2777e6e17e59302d492178c27bda60181a4da8712a2e7fc808561c1dae0812d18424c4e46c2927001a25d48004107bb15ee2";
$amo_crm_access_token = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImp0aSI6IjgzZDQ0ZGI0N2Q3ZDNlZjgwMDg4Nzg4YjQwZTEzNDllMWEwMjEwY2U0YjViMTdiNmRmZmE3OWU0YTQxNWUwNmE0ZmEyNmFkYmU1ZDIwZDQ5In0.eyJhdWQiOiI1ZTcyMjA0OC1kNWQ1LTQyMTQtOTZjOS1iM2RhNjJjZjNhMzMiLCJqdGkiOiI4M2Q0NGRiNDdkN2QzZWY4MDA4ODc4OGI0MGUxMzQ5ZTFhMDIxMGNlNGI1YjE3YjZkZmZhNzllNGE0MTVlMDZhNGZhMjZhZGJlNWQyMGQ0OSIsImlhdCI6MTY4Mzg5ODY4NywibmJmIjoxNjgzODk4Njg3LCJleHAiOjE2ODM5ODUwODcsInN1YiI6Ijk0NzUyNjIiLCJncmFudF90eXBlIjoiIiwiYWNjb3VudF9pZCI6MzA5OTE0MzAsImJhc2VfZG9tYWluIjoiYW1vY3JtLnJ1IiwidmVyc2lvbiI6InYyIiwic2NvcGVzIjpbInB1c2hfbm90aWZpY2F0aW9ucyIsImZpbGVzIiwiY3JtIiwiZmlsZXNfZGVsZXRlIiwibm90aWZpY2F0aW9ucyJdfQ.XaifTYIQISc4pHYYm6UfXffKkZeVqNq4qVU9ZuBAU3VpkZ2HhrDsZdUQ4Q5jVHYlqP33lTpZeCAun20LoYQb822GsmhoKoWICk00jrNmk_W2NKgE_7Gn48B6_kNbyTKwStJUUfuaMVbQpRfIvpZfN2sXcMtpVLz2XU_lFGnHV3Fyz7GcUkEuXZ4D-XtASAIP_6rf1lABG2Q1ty-j16kxRgRq4CFixoFRodGe6mpuvqe_b30oGSMZF-EpexlKXB98MtyLH5h6pbhHciFgbdJWJLCfFZhY-mHNdII30MhTH9Q3EgRi-o7SctBOwl1haiU8t7Besp5JOMV4B8jqiAkSWg";
$refresh_token = "def50200161ede7adfa990afb80eca7a8aa4c8495010c0f9936cd4bac5fe8ebcbde927cf8651e81af849a8e4e524ee3addb5f4d4a60bc3e2ebf58ac1a89d19bcd11b189e2c043922e0b4e72102ed55b688c8f21c3d9384c87fc3fb9caa70e53b55937b70a4448488241738ca37de6d3af5d32b19929b9dfeeecff92ec8d3c35b47b1d3463102866a3247012f61b1a96f80bea60946e96b4d89a450b736fe66a2aac4bbae8282ac7d5810d417cf073842d6e42567c8efdd649478b0b462fbad797acc29c0b34ea0e4c3cb26205f0f8e23d20321732ef673724711f504e0e73536befcd994c9eb2f297bbd0947d018609a486574aaecd533d11aab06e8a95f06d4853353cd33c4fdf436f9db0e018e9ba73eca64be59cd461f9b33f9cdf71d3e00b97b9ec1acefa5a935995172015d547950f0986c20d1ff1ce48d6c00817f52476607706d999588004a91acba8b6b1ddcad52dfc18d45dad14bd6441df1310b7f86a0564d9e64f0e9737d46cf2c80f560c976bcafe0e49ea673aa13775cfa8cc04989abdfa1d37610507c2f7057317981a4556bc6a7855ceff5168337180738f052edf79981b54c01c26bc797283d20f235f16350744a1838964c662895f5634445a14dd66081a74c2c5cd9d2cad38cced91020fb6af8530d36d7b03778ed954953cfbe3f096f1e2c94baa096d6d3f161";
$light_doc_token_auth = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzZXNzaW9uX2lkIjoiOTExNTMyIiwidXNlcl9hZ2VudCI6ImFnZW50IENocm9tZSBvbiBXaW5kb3dzIDEwIiwidXNlcl9pZCI6IjkxMTUxOCIsInNjb3BlIjoiIiwicmVmcmVzaF9leHBpcnkiOiIxOTk4ODEwMTg3IiwibmJmIjoxNjgzNDUwMTg3LCJleHAiOjE5OTg4MTAxODcsImlhdCI6MTY4MzQ1MDE4NywiaXNzIjoiaHR0cDovL2xpZ2h0ZG9jLmlvIiwiYXVkIjoibGlnaHRkb2NfY2xpZW50In0.Ba-OnGKs0qgL_EaKFmMpz0KZu5n2OK2Mb1iYlovt2z4";
$light_doc_domen = "api.demo.lightdoc.io";
$amo_domen = "vienna.amocrm.ru";

$delimetr = "-------------0123456789";

$fh = fopen("webhook.txt", 'w') or die("Сбой открытия");

$leads = $_POST['leads'];

fwrite($fh, "tmp");
fwrite($fh, print_r($leads,true));

$statusId = $leads['status']['0']['id'];
fwrite($fh, print_r($statusId,true). '\n');

if ($statusId != ""){
    
    $headers = [
        'Authorization: Bearer ' . $amo_crm_access_token
    ];

    $getLeadRequest = curl_init('https://'. $amo_domen . '/api/v4/leads/' . $statusId);
    curl_setopt($getLeadRequest, CURLOPT_HTTPGET, true);
    curl_setopt($getLeadRequest,CURLOPT_RETURNTRANSFER, true);
    curl_setopt($getLeadRequest,CURLOPT_USERAGENT,'amoCRM-oAuth-client/1.0');
    curl_setopt($getLeadRequest,CURLOPT_HTTPHEADER, $headers);
    curl_setopt($getLeadRequest,CURLOPT_HEADER, false);
    curl_setopt($getLeadRequest,CURLOPT_SSL_VERIFYPEER, 1);
    curl_setopt($getLeadRequest,CURLOPT_SSL_VERIFYHOST, 2);
    $resGetLead = curl_exec($getLeadRequest);

    $code = curl_getinfo($getLeadRequest, CURLINFO_HTTP_CODE);
    curl_close($getLeadRequest);

    $data = json_decode($resGetLead);

    if ($data != null){


        $lead_id  = $data->id;

        
    
        $custom_fields = $data->custom_fields_values;
    
    
        $lead_doc_fio = "";
        $lead_contact_email = "";
        $lead_doc_date = "";
        $lead_doc_link = "";
    
        foreach ($custom_fields as $field) {
            if ($field->field_id == 627833){
                if ($field->values[0]->value == null){
                    http_response_code(400);
                    echo "FIO in lead wasn't mentioned";
                }else{
                    $lead_doc_fio = explode(" ", $field->values[0]->value);
                }
            }
            else if ($field->field_id  == 627855){
                if ($field->values[0]->value == null){
                    http_response_code(400);
                    echo "Date in lead wasn't mentioned";
                }else{
                    $lead_doc_date = $field->values[0]->value;
                }
            }
            else if ($field->field_id  == 621947){
                if ($field->values[0]->value == null){
                    http_response_code(400);
                    echo "Doc link in lead wasn't mentioned";
                }else{
                    $lead_doc_link = $field->values[0]->value;
                }
            }
        };

        
        
        $light_doc_creation_payload = array(
            'id' => ($lead_id + 21) . '',
            'name' => 'Договор '. $lead_id . ' от ' . $lead_doc_date . 'г с ' . $lead_doc_fio[0] . ' ' . substr($lead_doc_fio[1], 0, 2) . '.',
            'isSequential' => false,
            'signers' => array(
                array(
                    'firstName' => $lead_doc_fio[0],
                    'lastName' => $lead_doc_fio[1],
                    'patronymic' => $lead_doc_fio[2],
                    'email' => "tmp",
                    'approveType' => "Bes"
                )
            )
        );
        
        $light_doc_creation_payload_json = json_encode($light_doc_creation_payload);
        
        $curl_light_doc_creation_req = curl_init();
        
        curl_setopt($curl_light_doc_creation_req, CURLOPT_URL, 'https://'. $light_doc_domen .'/v1/documents');
        curl_setopt($curl_light_doc_creation_req, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($curl_light_doc_creation_req, CURLOPT_POST, 1);
        curl_setopt($curl_light_doc_creation_req, CURLOPT_POSTFIELDS, $light_doc_creation_payload_json);
        curl_setopt($curl_light_doc_creation_req, CURLOPT_HTTPHEADER, array(
            'Content-Type: application/json',
            'Authorization: Bearer ' . $light_doc_token_auth
        ));

        
        
        $light_doc_creation_response_json = curl_exec($curl_light_doc_creation_req);
    
        $light_doc_creation_response = json_decode($light_doc_creation_response_json);
        
        $http_code = curl_getinfo($curl_light_doc_creation_req, CURLINFO_HTTP_CODE);
    
        curl_close($curl_light_doc_creation_req);
       
        fwrite($fh, $light_doc_creation_response_json);
    
        if ($http_code >= 200 && $http_code <= 226 ) {
    
            $light_doc_document_id = $light_doc_creation_response->documentID;
    
            $lead_doc_pdf = file_get_contents($lead_doc_link); 
    
            $local_file_path = 'filename.pdf';
    
            file_put_contents($local_file_path, $lead_doc_pdf);
    
            $pdf_data = curl_file_create($local_file_path, 'application/pdf', 'filename.pdf');
    
            $curl_light_doc_add_req = curl_init();

            fwrite($fh, "stap_add" . '\n');

            
            curl_setopt($curl_light_doc_add_req, CURLOPT_URL, 'https://'. $light_doc_domen .'/v1/documents/' . $light_doc_document_id . '/files');
            curl_setopt($curl_light_doc_add_req, CURLOPT_RETURNTRANSFER, 1);
            curl_setopt($curl_light_doc_add_req, CURLOPT_POST, 1);
            curl_setopt($curl_light_doc_add_req, CURLOPT_POSTFIELDS, array(
                "files" => $pdf_data
            ));
            curl_setopt($curl_light_doc_add_req, CURLOPT_HTTPHEADER, array(
                'Content-Type: multipart/form-data',
                'Authorization: Bearer ' . $light_doc_token_auth
            ));
    
            $light_doc_add_req_response_json = curl_exec($curl_light_doc_add_req);
            fwrite($fh, print_r($light_doc_add_req_response_json,true) . '\n');

            $http_code_add = curl_getinfo($curl_light_doc_add_req, CURLINFO_HTTP_CODE);
            
            curl_close($curl_light_doc_add_req);
    
            
    

            if (strpos($light_doc_add_req_response_json, "size")){

                $headers = [
                    'Authorization: Bearer ' . $amo_crm_access_token
                ];

                $updateLeadPayload = array(
                    array(
                        "id" => $lead_id,
                        "custom_fields_values" => [
                            array(
                                "field_id" => 627857,
                                "values" => [
                                    [
                                        "value" =>  $light_doc_document_id . ''
                                    ]
                                ]
                            )
                        ]
                    )
                );
            
                $updateLeadRequest = curl_init('https://'. $amo_domen . '/api/v4/leads');
                curl_setopt($updateLeadRequest, CURLOPT_CUSTOMREQUEST, 'PATCH');
                curl_setopt($updateLeadRequest,CURLOPT_RETURNTRANSFER, true);
                curl_setopt($updateLeadRequest,CURLOPT_USERAGENT,'amoCRM-oAuth-client/1.0');
                curl_setopt($updateLeadRequest,CURLOPT_HTTPHEADER, $headers);
                curl_setopt($updateLeadRequest, CURLOPT_POSTFIELDS, json_encode($updateLeadPayload));
                curl_setopt($updateLeadRequest,CURLOPT_HEADER, false);
                curl_setopt($updateLeadRequest,CURLOPT_SSL_VERIFYPEER, 1);
                curl_setopt($updateLeadRequest,CURLOPT_SSL_VERIFYHOST, 2);
                $resUpdateLead = curl_exec($updateLeadRequest);

                $http_code_update = curl_getinfo($updateLeadRequest, CURLINFO_HTTP_CODE);

                fwrite($fh, $resUpdateLead . '\n');
                fwrite($fh, $lead_id . '\n');

                http_response_code($http_code_add);
    
                echo $light_doc_add_req_response_json;

            }else{
                http_response_code($resUpdateLead);
            
                echo "Something went wrong";
            }
    
            
        } else {
    
            http_response_code($http_code);
            
            echo "Something went wrong";
        }
    }
    else{
        http_response_code(400);
        echo "Wrong lead format";
    }
}
else{
    http_response_code(400);
    echo "Wrong lead format";
}


function isJSON($string)
{
    return is_string($string) && is_array(json_decode($string, true)) && (json_last_error() == JSON_ERROR_NONE) ? true : false;
}


fclose($fh);

?>