<?php
$amo_crm_authorization_code = "def5020033d15509c0fec9d844505ad7ab2ad8bdb831880ed205db3bc050d13d04955ec260afb43db594a118c5d8277d35f6a11b89ccbe41c5dd70a5cf18543feea6500564ff0d1c46a67998780e248156e09035c35870b85519e82dee4a7b900ff6e1de608493e4d5242ef8f5a55f3b3902397e3b6ef3e76888afa28c4a438f6dd9debb9c670fe12d917f2d29a9aa56603182ca9944fac7c19da04d6a6e971c3786e968f0189eb037f0fc2e7c8b4ab949227a95238e830249d1bb59d2fb5030d7d79b8c0975a3b1ea831bac460d39ae17a006edcdb7235363b405dca763e6d0e0db9ec426e48ad58813b8aa719bd4bc1c3e4d0651ed39ce886672f7dc5ddba16cdeee50d75f69c5d1adfbd90536a12af895b587ee643de7a34df9d099dff9c6be78491bfacc8a5393aa6e1af84ef31abd4184a3667aa7c29b097e80e882c9292c938ca213249cbae38db80477637c6e72fbb85ded908c9773e756bb4b887a131b36d1ec07948263986904accae14c0aa2ef78367dc4b369f37d55432aafa82783524af31f63e69b28f0fa05e8b2f6145ac596fa2faed21448f3fc013af56fc467e6d338fe51c23d832b824be6f34e57dd0687bbcc3e7fd5018f1d007f30e5228eeccd2777e6e17e59302d492178c27bda60181a4da8712a2e7fc808561c1dae0812d18424c4e46c2927001a25d48004107bb15ee2";
$amo_crm_access_token = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImp0aSI6IjA0Y2U3MmVlMTJiZGY5NWNlZjAxYjhlNjJkMDkyYjViOTMzOWRkNmE4Yzg5N2JlOGVlZDgzNGM4ZGIzNjMzNmM1ZWU5YTkwOGY0ODNmNmFiIn0.eyJhdWQiOiI1ZTcyMjA0OC1kNWQ1LTQyMTQtOTZjOS1iM2RhNjJjZjNhMzMiLCJqdGkiOiIwNGNlNzJlZTEyYmRmOTVjZWYwMWI4ZTYyZDA5MmI1YjkzMzlkZDZhOGM4OTdiZThlZWQ4MzRjOGRiMzYzMzZjNWVlOWE5MDhmNDgzZjZhYiIsImlhdCI6MTY4NDAwNTAyOCwibmJmIjoxNjg0MDA1MDI4LCJleHAiOjE2ODQwOTE0MjgsInN1YiI6Ijk0NzUyNjIiLCJncmFudF90eXBlIjoiIiwiYWNjb3VudF9pZCI6MzA5OTE0MzAsImJhc2VfZG9tYWluIjoiYW1vY3JtLnJ1IiwidmVyc2lvbiI6InYyIiwic2NvcGVzIjpbInB1c2hfbm90aWZpY2F0aW9ucyIsImZpbGVzIiwiY3JtIiwiZmlsZXNfZGVsZXRlIiwibm90aWZpY2F0aW9ucyJdfQ.UXAtS40sC-14m7l8TEGt4YavbaqBjOXoo2xfvlH8ZGm3igLUy6y9vqOnXRT_kEwAyVd4LzJUk8bFMWOoo3gLVhv8GnWmy0MdrlKWGL0Emp5bc1GQSWYS7Cl16pZnmkxvfR3-XeRZK4BA4VNsEOXQ08_8jaCJa2a4tlbmyND1GvLQ_pY93zA4ArrrdSBcwlLrabu4Yb8icMHgHIxpLYuvctay25yMJWKAO9j2OZoaAeDO-vV5xURBatqJm6lT6LFOg9aNoUN7pTjMCdd8bym6aaixd106EHbDR0TUKK-tRFpT0H4PP8YTDwMECwr43BZkl_7c8VGocc1fOsE0FzjA4Q";
$refresh_token = "def50200ef5424adc9577196a3031a3d79b44302deda4e3713766e5a7a1541a28875fb96977ea602d9d40f7e3591ca48f59f6deaed5490dc44486cd2799cf95badee90caf1d4635b4386977f49a9d5bf17c8949a5fe12c7f0cebeb3cfb9dd7e454eafef354a66d35905b8e582024abf7e63b5910b6d22d85226e70b7cebbb777c5ecc669e32caedfde3dc72005ad51c3413a6780b06eb2cb094823a54dce62828656a43805bb5c78c41f2893f9809401c20ce3fb787142fe7ec6a24ba2f2ca75d2cdfff92d6d7a21daf574f6e387947af561afbb98ab28c03129569959a7ac6b480a97c5136c14dae1f2e6b36ed7fbbc45d5bac422b680d0f8dfad34088534df4eb1462cfcc7cbdce8d04ff9dbfbbf6ea84ce4d049a1e74d41ceb7f283b480e3c205646ad96b1aeee80d03c444ff4f3b46ffedfeefa05d509351554a6383a58d8e2fc3726bb1fe03ad2cd44b0ac5eca8929a18a6efda557a7c31129fb4645d3d2e2f826254fb96e420c7ff138b7360c2058173bf9c7e10d0d2511fd14038c7ca18cfdb8c84a91393bdb9c33d5afe92dc24afbdbd923a22a7b10c841be78cbf7c36ef74ce69817df0b7b221e49cc565a0e86805d3e4a50b5f7513c9c93c4d2cb6f4b61d9d637860bf12dd025a60a4618a0bace95472de033f50093c4130b70c9ad14342016b192686ef19b624d5bb747a";
$light_doc_token_auth = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzZXNzaW9uX2lkIjoiOTExNTMyIiwidXNlcl9hZ2VudCI6ImFnZW50IENocm9tZSBvbiBXaW5kb3dzIDEwIiwidXNlcl9pZCI6IjkxMTUxOCIsInNjb3BlIjoiIiwicmVmcmVzaF9leHBpcnkiOiIxOTk4ODEwMTg3IiwibmJmIjoxNjgzNDUwMTg3LCJleHAiOjE5OTg4MTAxODcsImlhdCI6MTY4MzQ1MDE4NywiaXNzIjoiaHR0cDovL2xpZ2h0ZG9jLmlvIiwiYXVkIjoibGlnaHRkb2NfY2xpZW50In0.Ba-OnGKs0qgL_EaKFmMpz0KZu5n2OK2Mb1iYlovt2z4";
$light_doc_domen = "api.demo.lightdoc.io";
$amo_domen = "vienna.amocrm.ru";

$leads = $_POST['leads'];

$statusId = $leads['status']['0']['id'];

$log_file = fopen("webhook.txt", "w");

fwrite($log_file, print_r($leads, true));

if ($statusId != ""){
    
    $headers = [
        'Authorization: Bearer ' . $amo_crm_access_token
    ];

    $getLeadRequest = curl_init('https://'. $amo_domen . '/api/v4/leads/' . $statusId . '?with=contacts');
    curl_setopt($getLeadRequest, CURLOPT_HTTPGET, true);
    curl_setopt($getLeadRequest,CURLOPT_RETURNTRANSFER, true);
    curl_setopt($getLeadRequest,CURLOPT_USERAGENT,'amoCRM-oAuth-client/1.0');
    curl_setopt($getLeadRequest,CURLOPT_HTTPHEADER, $headers);
    curl_setopt($getLeadRequest,CURLOPT_HEADER, false);
    curl_setopt($getLeadRequest,CURLOPT_SSL_VERIFYPEER, 1);
    curl_setopt($getLeadRequest,CURLOPT_SSL_VERIFYHOST, 2);
    $resGetLead = curl_exec($getLeadRequest);

    $code = curl_getinfo($getLeadRequest, CURLINFO_HTTP_CODE);
    curl_close($getLeadRequest);

    fwrite($log_file, print_r(json_decode($resGetLead), true));

    $data = json_decode($resGetLead);

    if ($data != null){


        $lead_id  = $data->id;

        
    
        $custom_fields = $data->custom_fields_values;
    
    
        $lead_doc_fio = "";
        $lead_contact_email = "";
        $lead_doc_date = "";
        $lead_doc_link = "";
    
        foreach ($custom_fields as $field) {
            if ($field->field_id == 627833){
                if ($field->values[0]->value == null){
                    http_response_code(400);
                    echo "FIO in lead wasn't mentioned";
                }else{
                    $lead_doc_fio = explode(" ", $field->values[0]->value);
                }
            }
            else if ($field->field_id  == 627855){
                if ($field->values[0]->value == null){
                    http_response_code(400);
                    echo "Date in lead wasn't mentioned";
                }else{
                    $lead_doc_date = $field->values[0]->value;
                }
            }
            else if ($field->field_id  == 621947){
                if ($field->values[0]->value == null){
                    http_response_code(400);
                    echo "Doc link in lead wasn't mentioned";
                }else{
                    $lead_doc_link = $field->values[0]->value;
                }
            }
        };

        $contact_id = $data->_embedded->contacts[0]->id;

        fwrite($log_file, "Embeded list");
        fwrite($log_file, print_r($data->_embedded,true));

        $headers = [
            'Authorization: Bearer ' . $amo_crm_access_token
        ];
    
        $getContactRequest = curl_init('https://'. $amo_domen . '/api/v4/contacts/' . $contact_id);
        curl_setopt($getContactRequest, CURLOPT_HTTPGET, true);
        curl_setopt($getContactRequest,CURLOPT_RETURNTRANSFER, true);
        curl_setopt($getContactRequest,CURLOPT_USERAGENT,'amoCRM-oAuth-client/1.0');
        curl_setopt($getContactRequest,CURLOPT_HTTPHEADER, $headers);
        curl_setopt($getContactRequest,CURLOPT_HEADER, false);
        curl_setopt($getContactRequest,CURLOPT_SSL_VERIFYPEER, 1);
        curl_setopt($getContactRequest,CURLOPT_SSL_VERIFYHOST, 2);
        $resGetEmail = curl_exec($getContactRequest);
    
        $code = curl_getinfo($getContactRequest, CURLINFO_HTTP_CODE);
        curl_close($getContactRequest);

        fwrite($log_file, "Contact");
        fwrite($log_file, print_r(json_decode($resGetEmail),true));

        $custom_field_values = getCustomFieldValues(json_decode($resGetEmail), array(64239));

        fwrite($log_file, "Custom field values");
        fwrite($log_file, print_r($custom_field_values,true));

        $lead_contact_email = $custom_field_values[64239];

        fwrite($log_file, "Email: " . $lead_contact_email);
        
        $light_doc_creation_payload = array(
            'id' => $lead_id + 57 . '',
            'name' => 'Договор '. $lead_id . ' от ' . $lead_doc_date . 'г с ' . $lead_doc_fio[0] . ' ' . substr($lead_doc_fio[1], 0, 2) . '.',
            'isSequential' => false,
            'signers' => array(
                array(
                    'firstName' => $lead_doc_fio[0],
                    'lastName' => $lead_doc_fio[1],
                    'patronymic' => $lead_doc_fio[2],
                    'email' => $lead_contact_email,
                    'approveType' => "Bes"
                )
            )
        );
        
        $light_doc_creation_payload_json = json_encode($light_doc_creation_payload);
        
        $curl_light_doc_creation_req = curl_init();
        
        curl_setopt($curl_light_doc_creation_req, CURLOPT_URL, 'https://'. $light_doc_domen .'/v1/documents');
        curl_setopt($curl_light_doc_creation_req, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($curl_light_doc_creation_req, CURLOPT_POST, 1);
        curl_setopt($curl_light_doc_creation_req, CURLOPT_POSTFIELDS, $light_doc_creation_payload_json);
        curl_setopt($curl_light_doc_creation_req, CURLOPT_HTTPHEADER, array(
            'Content-Type: application/json',
            'Authorization: Bearer ' . $light_doc_token_auth
        ));

        $light_doc_creation_response_json = curl_exec($curl_light_doc_creation_req);

        fwrite($log_file, print_r($light_doc_creation_response_json, true));
    
        $light_doc_creation_response = json_decode($light_doc_creation_response_json);
        
        $http_code = curl_getinfo($curl_light_doc_creation_req, CURLINFO_HTTP_CODE);
    
        curl_close($curl_light_doc_creation_req);
    
        if ($http_code >= 200 && $http_code <= 226 ) {
    
            $light_doc_document_id = $light_doc_creation_response->documentID;
    
            $lead_doc_pdf = file_get_contents($lead_doc_link); 
    
            $local_file_path = 'filename.pdf';
    
            file_put_contents($local_file_path, $lead_doc_pdf);
    
            $pdf_data = curl_file_create($local_file_path, 'application/pdf', 'filename.pdf');
    
            $curl_light_doc_add_req = curl_init();
            
            curl_setopt($curl_light_doc_add_req, CURLOPT_URL, 'https://'. $light_doc_domen .'/v1/documents/' . $light_doc_document_id . '/files');
            curl_setopt($curl_light_doc_add_req, CURLOPT_RETURNTRANSFER, 1);
            curl_setopt($curl_light_doc_add_req, CURLOPT_POST, 1);
            curl_setopt($curl_light_doc_add_req, CURLOPT_POSTFIELDS, array(
                "files" => $pdf_data
            ));
            curl_setopt($curl_light_doc_add_req, CURLOPT_HTTPHEADER, array(
                'Content-Type: multipart/form-data',
                'Authorization: Bearer ' . $light_doc_token_auth
            ));
    
            $light_doc_add_req_response_json = curl_exec($curl_light_doc_add_req);

            fwrite($log_file, print_r($light_doc_add_req_response_json, true));

            $http_code_add = curl_getinfo($curl_light_doc_add_req, CURLINFO_HTTP_CODE);
            
            curl_close($curl_light_doc_add_req);
    
            
    

            if (strpos($light_doc_add_req_response_json, "size")){

                $headers = [
                    'Authorization: Bearer ' . $amo_crm_access_token
                ];

                $updateLeadPayload = array(
                    array(
                        "id" => $lead_id,
                        "custom_fields_values" => [
                            array(
                                "field_id" => 1100415, 
                                "values" => [
                                    [
                                        "value" =>  $light_doc_document_id
                                    ]
                                ]
                            )
                        ]
                    )
                );
            
                $updateLeadRequest = curl_init('https://'. $amo_domen . '/api/v4/leads');
                curl_setopt($updateLeadRequest, CURLOPT_CUSTOMREQUEST, 'PATCH');
                curl_setopt($updateLeadRequest,CURLOPT_RETURNTRANSFER, true);
                curl_setopt($updateLeadRequest,CURLOPT_USERAGENT,'amoCRM-oAuth-client/1.0');
                curl_setopt($updateLeadRequest,CURLOPT_HTTPHEADER, $headers);
                curl_setopt($updateLeadRequest, CURLOPT_POSTFIELDS, json_encode($updateLeadPayload));
                curl_setopt($updateLeadRequest,CURLOPT_HEADER, false);
                curl_setopt($updateLeadRequest,CURLOPT_SSL_VERIFYPEER, 1);
                curl_setopt($updateLeadRequest,CURLOPT_SSL_VERIFYHOST, 2);
                $resUpdateLead = curl_exec($updateLeadRequest);

                fwrite($log_file, print_r($resUpdateLead, true));

                $http_code_update = curl_getinfo($updateLeadRequest, CURLINFO_HTTP_CODE);

                http_response_code($http_code_add);
    
                echo $light_doc_add_req_response_json;

            }else{
                http_response_code($resUpdateLead);
            
                echo "Something went wrong";
            }
    
            
        } else {
    
            http_response_code($http_code);
            
            echo "Something went wrong";
        }
    }
    else{
        http_response_code(400);
        echo "Wrong lead format";
    }
}
else{
    http_response_code(400);
    echo "Wrong lead format";
}


function isJSON($string)
{
    return is_string($string) && is_array(json_decode($string, true)) && (json_last_error() == JSON_ERROR_NONE) ? true : false;
}

function getCustomFieldValues($contact, $fieldIds) {
    $customFields = $contact->custom_fields_values;
    $result = array();
    foreach ($fieldIds as $fieldId) {
        foreach ($customFields as $customField) {
            if ($customField->field_id == $fieldId) {
                $values = $customField->values;
                $result[$fieldId] = $values[0]->value;
                break;
            }
        }
    }
    return $result;
}

fclose($log_file);

?>